language: python
python:
- 3.6

services:
  - docker

before_install:
  # https://elk-docker.readthedocs.io/#es-not-starting-max-map-count
  # mostly used by ELK stack; Solving issue #252
  # - sudo sysctl -w vm.max_map_count=262144
  - |
        cd deployments/docker
        # make -C images pull # Not used at the moment, cuz we don't manage to build from cache
        make -C images images
        make bootstrap

install:
  - pip3.6 install -r requirements.txt
  - docker network create cega
  - docker-compose up -d ${DOCKER_CONTAINERS}
  - docker-compose ps

script:
  # https://docs.travis-ci.com/user/database-setup/#ElasticSearch
  # takes a few seconds to start and that delays everything
  # comment out sleep if no ELK stack is used; Solving issue #252
  # - sleep 20
  - cd ../../tests
  - mvn test -B

after_success:
  - |
        if [ "$TRAVIS_BRANCH" == "dev" ] && [ "$TRAVIS_PULL_REQUEST" == "false" ]; then
            docker login -u $DOCKER_USER -p $DOCKER_PASSWORD
            make -C ../deployments/docker/images -j 4 push
        fi

notifications:
  email: false
  slack:
    secure: eUyEWWvrFbzW+j+WKIOrHm7zeJ+6+o/WmI5cp1UYsOT9emxGE4kzW057cG9EV+sgKUdoYP1zSfCH0TLSOjY7otyqccqZH5WxDtiBSEXpkA8ID8jzQnX1VZWFn1vK+gWpER87VdLonVGt4db1lqE3Gm/uCbEqzrmfYjE1Hrk4PM8FfLQfD3+YBPUnWGSZKAPmdHAKh7IF9VQ6f1zaspijp/Sxa7Dk9F+Z4o2nsZ1woSyOVAwWLJhkvEafyEFfb/9tPMF1wtoXlLEzV1JDRzyjzbLGXQcpo6+Qx3+v7w6eRbriifOq2tByBfeI+RlWytwOgb+B/mfN0uFPbdg/Bgr//NMDrqwCnFQs7A2Dj287mQZI4YpRvh4Cneu3ReVGQKd9SJq28BliwXBBv3xyeFfGEbBOMNKb0VCsNjRuWITncf/qx3Vxn13VAYxcdA9EZpa1UzT6V94nlbLUq3twFKBJiDmpraYnI+JGFCZ32Xh8bySNqbEBe7TnqAG015c4pKKx++3IQJePfSPbRKzwWNAM5yG7RuVmud5fxfN+KdQz7vKfjOeaHKG4PScfhRT0zthtgmPG+m5eCprIbdFlacU3UyobLtxZd8wI9qJnGGvB3bHOsuaqpS2ymDWbd/n1aeryrcTkS/gPuwMvTs6S32pRf/orKqyLfnSZPeTcOevbzHw=
