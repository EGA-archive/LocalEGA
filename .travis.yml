language: python

python: 3.6
install:
  - echo "Dependencies on Travis? No, thanks"

git:
  depth: false
  quiet: true

services: docker

# command to install dependencies

stages:
  - name: unit tests
    if: type IN (push, pull_request)
  - name: integration tests
    if: type IN (pull_request)
  - name: update docker images
    if: type IN (pull_request)

jobs:
  include:
    - stage: unit tests
      python: 3.6
      before_script:
        - pip install tox-travis
      # command to run tests
      script: tox
    - stage: integration tests
      before_script:
        - cd deploy
        - ../extras/travis_prepare_images.sh
        - make bootstrap
        - sudo chown -R travis private
        - docker network create cega
        - make up
        - make ps
      script:
        - sleep 5
        - pip install idna==2.7 pika
        - pip install -r https://raw.githubusercontent.com/NBISweden/LocalEGA-cryptor/master/requirements.txt
        - pip install git+https://github.com/NBISweden/LocalEGA-cryptor.git
        - make -C test
        - sleep 10
        - make -C test check
    - stage: update docker images
      script: ./extras/travis_push_docker_hub.sh
