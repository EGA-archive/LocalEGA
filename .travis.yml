language: python

python: 3.6
# Skip a specific installation phase
install: true

git:
  depth: false
  quiet: true

stages:
  - name: tests
    if: type IN (push, pull_request)
  - name: image build and upload
    if: type IN (pull_request) AND branch = master

jobs:
  include:
    - stage: tests
      before_script:
        - pip install tox-travis
      script: tox
    - stage: tests
      services: docker
      before_script:
        - cd deploy
        - make -C images pull os-check base-check inbox-check
        - make bootstrap ARGS='--keyserver ega'
        - sudo chown -R travis private
        - make network up ps
      script:
        - cd ../tests
        - bats integration
    # Force images build and upload them
    - stage: image build and upload
      script:
        - make -C images all push
